document.addEventListener("DOMContentLoaded",()=>{document.startViewTransition||(document.startViewTransition=e=>e()),fetch("/TCM/js/data.min.js").then(e=>e.json()).then(e=>{window.carsData=e,r()}).catch(e=>{console.error("Error al cargar los datos dinámicamente:",e)});let n=document.getElementById("carGrid"),a=document.getElementById("categoryTabs"),c=document.getElementById("carCardTemplate"),i=document.getElementById("brandSliderTemplate"),s=document.getElementById("searchInput"),e=document.getElementById("categorySlider"),t=document.getElementById("clearSearch"),o=document.getElementById("matchCount"),d=!1,u=null,m=["Street Tire 1","Street Tire 2","Drift","Racing","Hypercar","Alpha GP","Motocross","Rally Raid","Rally","Monster"];function r(){var e,t=new URLSearchParams(window.location.search).get("category"),r=[...new Set(carsData.cars.map(e=>e.category))].sort((e,t)=>m.indexOf(e)-m.indexOf(t));e=r,a.innerHTML="",e.forEach((e,t)=>{var r=document.createElement("button");r.className="tab-button "+(e===u?"active":""),r.textContent=e,r.addEventListener("click",()=>{d=!1,u=e,s.value="",f(),v(e)}),a.appendChild(r)});{let e=document.querySelector(".category-slider"),o=e.querySelector(".tabs"),t=e.querySelector(".prev"),r=e.querySelector(".next"),l=0;function n(){var e,t,r=o.querySelector(".tab-button.active");r&&(0===(t=(e=Array.from(o.querySelectorAll(".tab-button"))).indexOf(r))?o.scrollLeft=0:t===e.length-1?o.scrollLeft=o.scrollWidth:(t=r.getBoundingClientRect(),e=o.getBoundingClientRect(),r=t.left+t.width/2,t=e.left+e.width/2,o.scrollLeft+=r-t))}r.addEventListener("click",()=>{(l+=100)>o.scrollWidth-o.clientWidth&&(l=o.scrollWidth-o.clientWidth),o.scrollTo({left:l,behavior:"smooth"})}),t.addEventListener("click",()=>{(l-=100)<0&&(l=0),o.scrollTo({left:l,behavior:"smooth"})}),o.addEventListener("scroll",()=>{l=o.scrollLeft}),o.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{setTimeout(n,50)})}),setTimeout(n,100)}let o,l=(o=t&&r.includes(t)?t:(e=localStorage.getItem("currentCategory"))&&r.includes(e)?e:r[0],u=o,localStorage.getItem("lastSearch"));setTimeout(()=>{l&&""!==l.trim()?(s.value=l,d=!0,y(l)):v(o);var e=localStorage.getItem("scrollPosition"),t=localStorage.getItem("categoryScrollPosition");e&&window.scrollTo(0,Number.parseInt(e)),t&&(document.querySelector(".category-slider .tabs").scrollLeft=Number.parseInt(t)),f()},50)}function f(){t.style.display=s.value?"block":"none",o.style.display=s.value?"block":"none",e.style.display=s.value?"none":"flex",document.querySelector(".search-container").style.left=s.value?"-23px":"0px",s.value||(s.style.border="solid 1px #ffffff17")}function h(e,t){if(!t||0===t.length)return e;let r=e;return t.forEach(e=>{0<e.length&&(e=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),e=new RegExp(`(${e})`,"gi"),r=r.replace(e,'<span class="highlight">$1</span>'))}),r}function g(e,t=[]){var r=c.content.cloneNode(!0),o=r.querySelector(".car-image");o.src=e.image,o.alt=e.name,o.style.viewTransitionName="car-image-"+e.id,r.querySelector(".brand-logo").src=e.brand.logo,r.querySelector(".brand-logo").alt=e.brand.name;r.querySelector(".car-name").innerHTML=h(e.name,t);var o=r.querySelector(".car-details"),l=e.brand.name+" • "+e.year;o.innerHTML=h(l,t);r.querySelector(".car-description").innerHTML=h(e.description,t);o=r.querySelector(".car-card");return o.addEventListener("click",()=>{localStorage.setItem("viewingCarId",e.id),localStorage.setItem("scrollPosition",window.scrollY),localStorage.setItem("categoryScrollPosition",document.querySelector(".category-slider .tabs").scrollLeft),""!==s.value.trim()?localStorage.setItem("lastSearch",s.value):localStorage.removeItem("lastSearch"),localStorage.setItem("currentCategory",u||document.querySelector(".tab-button.active")?.textContent||m[0]),document.startViewTransition?document.startViewTransition(()=>{window.location.href="car-details.html?id="+encodeURIComponent(e.id)}):window.location.href="car-details.html?id="+encodeURIComponent(e.id)}),o}function y(e){if(e){0<e.length&&(u=u||document.querySelector(".tab-button.active")?.textContent||m[0],document.querySelectorAll(".tab-button").forEach(e=>{e.classList.remove("active")}));let l=e.split(/\s+/).filter(e=>0<e.length);var r=carsData.cars.filter(e=>{let t=[e.name.toLowerCase(),e.brand.name.toLowerCase(),e.category.toLowerCase(),e.description.toLowerCase(),e.year.toString()].join(" ");return l.every(e=>t.includes(e))});if(o&&(o.textContent=r.length.toString(),o.style.color=0<r.length?"#00ff00":"#ff0000"),0<r.length){let t=r.reduce((e,t)=>(e[t.brand.name]||(e[t.brand.name]=[]),e[t.brand.name].push(t),e),{});n.innerHTML="",Object.keys(t).sort((e,t)=>e.localeCompare(t)).forEach(e=>{var r=t[e];if(0<r.length){var o=i.content.cloneNode(!0);o.querySelector(".brand-name").textContent=e;let t=o.querySelector(".slider-content");r.forEach(e=>{e=g(e,l);t.appendChild(e)}),n.appendChild(o),b(n.lastElementChild)}}),s.style.border="solid 1px #ffffff17",o.style.border="solid 1px #ffffff91"}else s.style.border="solid 1px #ec0b0b",o.style.border="solid 1px #ec0b0b",n.innerHTML=`
        <div class="no-results">
          <p>No se encontraron autos que coincidan con "${e}"</p>
          <button class="newIssue" onclick="window.location.href='https://github.com/EDDIT8/TCM/issues/new?template=solicitud_de_ajustes.yml';" arial-label="Solicitar auto">Solicitar Ajustes <svg xmlns="http://www.w3.org/2000/svg" width="15px" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
          </svg>
          </button>
        </div>
      `}else d&&(d=!1,u?v(u):v(m[0])),s.style.border="solid 1px #ffffff17"}function v(t){u=t,document.querySelectorAll(".tab-button").forEach(e=>{e.classList.toggle("active",e.textContent===t)});let l=carsData.cars.filter(e=>e.category===t).reduce((e,t)=>(e[t.brand.name]||(e[t.brand.name]=[]),e[t.brand.name].push(t),e),{});var e=Object.keys(l).sort((e,t)=>e.localeCompare(t));n.innerHTML="",e.forEach(e=>{var t=l[e],r=i.content.cloneNode(!0);r.querySelector(".brand-name").textContent=e;let o=r.querySelector(".slider-content");t.forEach(e=>{e=g(e);o.appendChild(e)}),n.appendChild(r),b(n.lastElementChild)}),localStorage.setItem("currentCategory",t)}function b(e){let t=e.querySelector(".slider-content"),r=e.querySelector(".prev"),o=e.querySelector(".next"),l=0;function n(){r.style.display=0<t.scrollLeft?"block":"none",o.style.display=t.scrollLeft<t.scrollWidth-t.clientWidth?"block":"none"}o.addEventListener("click",()=>{(l+=200)>t.scrollWidth-t.clientWidth&&(l=t.scrollWidth-t.clientWidth),t.scrollTo({left:l,behavior:"smooth"}),n()}),r.addEventListener("click",()=>{(l-=200)<0&&(l=0),t.scrollTo({left:l,behavior:"smooth"}),n()}),t.addEventListener("scroll",()=>{l=t.scrollLeft,n()}),n()}r(),s.addEventListener("input",()=>{var e,t=s.value.toLowerCase().trim();(d=0<t.length)||(e=document.querySelector(".tab-button.active")?.textContent)&&(u=e),y(t),f()}),t.addEventListener("click",()=>{s.value="",d=!1,v(u||m[0]),f(),s.blur(),s.style.border="solid 1px #ffffff17"}),new MutationObserver(e=>{e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{1===e.nodeType&&e.querySelectorAll(".car-image, .brand-logo").forEach(e=>{e.onerror=function(){this.src="/placeholder.svg"}})})})}).observe(document.body,{childList:!0,subtree:!0})}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/TCM/service-worker.js").then(e=>{console.log("ServiceWorker registrado con éxito:",e)}).catch(e=>{console.log("Error en el registro del ServiceWorker:",e)})});