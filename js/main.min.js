document.addEventListener("DOMContentLoaded",()=>{document.startViewTransition||(document.startViewTransition=e=>e());let n=document.getElementById("carGrid"),l=document.getElementById("categoryTabs"),a=document.getElementById("carCardTemplate"),c=document.getElementById("brandSliderTemplate"),i=document.getElementById("searchInput"),e=document.getElementById("categorySlider"),t=document.getElementById("clearSearch"),o=document.getElementById("matchCount"),s=!1,d=null,u=["Street Tire 1","Street Tire 2","Drift","Racing","Hypercar","Alpha GP","Motocross","Rally Raid","Rally","Monster"];function r(){var e=new URLSearchParams(window.location.search).get("category"),t=[...new Set(carsData.cars.map(e=>e.category))].sort((e,t)=>u.indexOf(e)-u.indexOf(t));t.forEach((e,t)=>{var r=document.createElement("button");r.className="tab-button "+(e===d?"active":""),r.textContent=e,r.addEventListener("click",()=>{s=!1,d=e,i.value="",m(),h(e)}),l.appendChild(r)});{let e=document.querySelector(".category-slider"),o=e.querySelector(".tabs"),t=e.querySelector(".prev"),r=e.querySelector(".next"),l=0;function n(){var e,t,r=o.querySelector(".tab-button.active");r&&(0===(t=(e=Array.from(o.querySelectorAll(".tab-button"))).indexOf(r))?o.scrollLeft=0:t===e.length-1?o.scrollLeft=o.scrollWidth:(t=r.getBoundingClientRect(),e=o.getBoundingClientRect(),r=t.left+t.width/2,t=e.left+e.width/2,o.scrollLeft+=r-t))}r.addEventListener("click",()=>{(l+=100)>o.scrollWidth-o.clientWidth&&(l=o.scrollWidth-o.clientWidth),o.scrollTo({left:l,behavior:"smooth"})}),t.addEventListener("click",()=>{(l-=100)<0&&(l=0),o.scrollTo({left:l,behavior:"smooth"})}),o.addEventListener("scroll",()=>{l=o.scrollLeft}),o.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{setTimeout(n,50)})}),setTimeout(n,100)}let r,o=(r=e&&t.includes(e)?e:(e=localStorage.getItem("currentCategory"))&&t.includes(e)?e:t[0],d=r,localStorage.getItem("lastSearch"));setTimeout(()=>{o&&""!==o.trim()?(i.value=o,s=!0,y(o)):h(r);var e=localStorage.getItem("scrollPosition"),t=localStorage.getItem("categoryScrollPosition");e&&window.scrollTo(0,Number.parseInt(e)),t&&(document.querySelector(".category-slider .tabs").scrollLeft=Number.parseInt(t)),m()},50)}function m(){t.style.display=i.value?"block":"none",o.style.display=i.value?"block":"none",e.style.display=i.value?"none":"flex",document.querySelector(".search-container").style.left=i.value?"-23px":"0px",i.value||(i.style.border="solid 1px #ffffff17")}function f(e,t){if(!t||0===t.length)return e;let r=e;return t.forEach(e=>{0<e.length&&(e=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),e=new RegExp(`(${e})`,"gi"),r=r.replace(e,'<span class="highlight">$1</span>'))}),r}function g(e,t=[]){var r=a.content.cloneNode(!0),o=r.querySelector(".car-image");o.src=e.image,o.alt=e.name,o.style.viewTransitionName="car-image-"+e.id,r.querySelector(".brand-logo").src=e.brand.logo,r.querySelector(".brand-logo").alt=e.brand.name;r.querySelector(".car-name").innerHTML=f(e.name,t);var o=r.querySelector(".car-details"),l=e.brand.name+" • "+e.year;o.innerHTML=f(l,t);r.querySelector(".car-description").innerHTML=f(e.description,t);o=r.querySelector(".car-card");return o.addEventListener("click",()=>{localStorage.setItem("viewingCarId",e.id),localStorage.setItem("scrollPosition",window.scrollY),localStorage.setItem("categoryScrollPosition",document.querySelector(".category-slider .tabs").scrollLeft),""!==i.value.trim()?localStorage.setItem("lastSearch",i.value):localStorage.removeItem("lastSearch"),localStorage.setItem("currentCategory",d||document.querySelector(".tab-button.active")?.textContent||u[0]),document.startViewTransition?document.startViewTransition(()=>{window.location.href="car-details.html?id="+encodeURIComponent(e.id)}):window.location.href="car-details.html?id="+encodeURIComponent(e.id)}),o}function y(e){if(e){0<e.length&&(d=d||document.querySelector(".tab-button.active")?.textContent||u[0],document.querySelectorAll(".tab-button").forEach(e=>{e.classList.remove("active")}));let l=e.split(/\s+/).filter(e=>0<e.length);var r=carsData.cars.filter(e=>{let t=[e.name.toLowerCase(),e.brand.name.toLowerCase(),e.category.toLowerCase(),e.description.toLowerCase(),e.year.toString()].join(" ");return l.every(e=>t.includes(e))});if(o&&(o.textContent=r.length.toString(),o.style.color=0<r.length?"#00ff00":"#ff0000"),0<r.length){let t=r.reduce((e,t)=>(e[t.brand.name]||(e[t.brand.name]=[]),e[t.brand.name].push(t),e),{});n.innerHTML="",Object.keys(t).sort((e,t)=>e.localeCompare(t)).forEach(e=>{var r=t[e];if(0<r.length){var o=c.content.cloneNode(!0);o.querySelector(".brand-name").textContent=e;let t=o.querySelector(".slider-content");r.forEach(e=>{e=g(e,l);t.appendChild(e)}),n.appendChild(o),v(n.lastElementChild)}}),i.style.border="solid 1px #ffffff17",o.style.border="solid 1px #ffffff91"}else i.style.border="solid 1px #ec0b0b",o.style.border="solid 1px #ec0b0b",n.innerHTML=`
        <div class="no-results">
          <p>No se encontraron autos que coincidan con "${e}"</p>
          <button class="newIssue" onclick="window.location.href='https://github.com/EDDIT8/TCM/issues/new?template=solicitud_de_ajustes.yml';" arial-label="Solicitar auto">Solicitar Ajustes <svg xmlns="http://www.w3.org/2000/svg" width="15px" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
          </svg>
          </button>
        </div>
      `}else s&&(s=!1,d?h(d):h(u[0])),i.style.border="solid 1px #ffffff17"}function h(t){d=t,document.querySelectorAll(".tab-button").forEach(e=>{e.classList.toggle("active",e.textContent===t)});let l=carsData.cars.filter(e=>e.category===t).reduce((e,t)=>(e[t.brand.name]||(e[t.brand.name]=[]),e[t.brand.name].push(t),e),{});var e=Object.keys(l).sort((e,t)=>e.localeCompare(t));n.innerHTML="",e.forEach(e=>{var t=l[e],r=c.content.cloneNode(!0);r.querySelector(".brand-name").textContent=e;let o=r.querySelector(".slider-content");t.forEach(e=>{e=g(e);o.appendChild(e)}),n.appendChild(r),v(n.lastElementChild)}),localStorage.setItem("currentCategory",t)}function v(e){let t=e.querySelector(".slider-content"),r=e.querySelector(".prev"),o=e.querySelector(".next"),l=0;function n(){r.style.display=0<t.scrollLeft?"block":"none",o.style.display=t.scrollLeft<t.scrollWidth-t.clientWidth?"block":"none"}o.addEventListener("click",()=>{(l+=200)>t.scrollWidth-t.clientWidth&&(l=t.scrollWidth-t.clientWidth),t.scrollTo({left:l,behavior:"smooth"}),n()}),r.addEventListener("click",()=>{(l-=200)<0&&(l=0),t.scrollTo({left:l,behavior:"smooth"}),n()}),t.addEventListener("scroll",()=>{l=t.scrollLeft,n()}),n()}r(),i.addEventListener("input",()=>{var e,t=i.value.toLowerCase().trim();(s=0<t.length)||(e=document.querySelector(".tab-button.active")?.textContent)&&(d=e),y(t),m()}),t.addEventListener("click",()=>{i.value="",s=!1,h(d||u[0]),m(),i.blur(),i.style.border="solid 1px #ffffff17"}),new MutationObserver(e=>{e.forEach(e=>{"childList"===e.type&&e.addedNodes.forEach(e=>{1===e.nodeType&&e.querySelectorAll(".car-image, .brand-logo").forEach(e=>{e.onerror=function(){this.src="/placeholder.svg"}})})})}).observe(document.body,{childList:!0,subtree:!0}),"undefined"==typeof carsData?console.error("Error: carsData no está definido. Asegúrate de que data.js esté cargado."):r()}),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/TCM/service-worker.js").then(e=>{console.log("ServiceWorker registrado con éxito:",e)}).catch(e=>{console.log("Error en el registro del ServiceWorker:",e)})});